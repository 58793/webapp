name: CD (deploy to ECS)

on:
  workflow_run:
    workflows: ["CI (tests)"]   
    types: [completed]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REPOSITORY: ${{ vars.ECR_REPO }}
  ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
  ECS_SERVICE: ${{ vars.ECS_SERVICE }}
  ECS_TASK_FAMILY: ${{ vars.ECS_TASK_FAMILY }}
  CONTAINER_NAME: ${{ vars.ECS_CONTAINER_NAME }}
  ROLE_TO_ASSUME: ${{ vars.AWS_ROLE_TO_ASSUME }}

jobs:
  deploy:
    # Run if manually triggered OR CI workflow succeeded on main
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout (exact commit that passed CI)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tag
        id: meta
        run: |
          set -euo pipefail
          SHA="${{ github.event.workflow_run.head_sha || github.sha }}"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Build + Push image (linux/amd64)
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.meta.outputs.sha }}
        run: |
          set -euo pipefail
          IMAGE_URI="$ECR_REGISTRY/${ECR_REPOSITORY}:$IMAGE_TAG"
          docker build --platform linux/amd64 -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"
          echo "image=$IMAGE_URI" >> "$GITHUB_OUTPUT"

      - name: Fetch current task definition
        run: |
          set -euo pipefail
          aws ecs describe-task-definition \
            --region "$AWS_REGION" \
            --task-definition "$ECS_TASK_FAMILY" \
            --query taskDefinition > taskdef.json

      - name: Render new task definition (image + APP_VERSION)
        run: |
          set -euo pipefail

          jq 'del(
            .taskDefinitionArn,
            .revision,
            .status,
            .requiresAttributes,
            .compatibilities,
            .registeredAt,
            .registeredBy
          )' taskdef.json > taskdef-clean.json

          jq --arg NAME "$CONTAINER_NAME" \
             --arg IMAGE "${{ steps.build-image.outputs.image }}" \
             --arg APP_VERSION "${{ steps.meta.outputs.sha }}" \
             '
             (.containerDefinitions[] | select(.name==$NAME) | .image) = $IMAGE
             |
             (.containerDefinitions[] | select(.name==$NAME) | .environment) =
               (
                 ((.containerDefinitions[] | select(.name==$NAME) | .environment) // [])
                 | map(select(.name != "APP_VERSION"))
                 + [{"name":"APP_VERSION","value":$APP_VERSION}]
               )
             ' taskdef-clean.json > taskdef-updated.json

      - name: Register task definition
        id: register
        run: |
          set -euo pipefail
          NEW_TD_ARN=$(aws ecs register-task-definition \
            --region "$AWS_REGION" \
            --cli-input-json file://taskdef-updated.json \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)
          echo "arn=$NEW_TD_ARN" >> "$GITHUB_OUTPUT"
          echo "✅ Registered: $NEW_TD_ARN"

      - name: Update ECS service
        run: |
          set -euo pipefail
          aws ecs update-service \
            --region "$AWS_REGION" \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --task-definition "${{ steps.register.outputs.arn }}" \
            --force-new-deployment

      - name: Wait for ECS stable
        run: |
          set -euo pipefail
          aws ecs wait services-stable \
            --region "$AWS_REGION" \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE"

      - name: Deployment proof (verify running image == pushed image)
        run: |
          set -euo pipefail

          TD=$(aws ecs describe-services \
            --region "$AWS_REGION" \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE" \
            --query 'services[0].taskDefinition' --output text)

          RUNNING_IMAGE=$(aws ecs describe-task-definition \
            --region "$AWS_REGION" \
            --task-definition "$TD" \
            --query "taskDefinition.containerDefinitions[?name=='$CONTAINER_NAME'].image | [0]" \
            --output text)

          echo "TaskDefinition: $TD"
          echo "Running image: $RUNNING_IMAGE"
          echo "Expected image: ${{ steps.build-image.outputs.image }}"

          test "$RUNNING_IMAGE" = "${{ steps.build-image.outputs.image }}"
          echo "✅ Deployment proof passed"